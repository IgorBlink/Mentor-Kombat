<!DOCTYPE html>
<html>
<head>
    <title>Test MK.js - Fixed Version</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #1a1a1a;
            color: white;
            font-family: Arial, sans-serif;
        }
        #arena {
            border: 2px solid #fbbf24;
            width: 800px;
            height: 400px;
            background: black;
            margin: 20px auto;
        }
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        button {
            margin: 10px;
            padding: 10px 20px;
            background: #fbbf24;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            color: #000;
        }
        button:hover { background: #f59e0b; }
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        .log {
            background: #222;
            padding: 15px;
            margin: 20px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            border-radius: 8px;
        }
        .status {
            text-align: center;
            font-size: 18px;
            margin: 20px;
        }
        .status.loading { color: #fbbf24; }
        .status.error { color: #ef4444; }
        .status.success { color: #10b981; }
    </style>
</head>
<body>
    <h1>üéÆ MK.js - Fixed Test</h1>
    
    <div class="status" id="status">Ready to start</div>
    
    <div class="controls">
        <button onclick="startGame()" id="startBtn">üöÄ Start Game</button>
        <button onclick="stopGame()" id="stopBtn" disabled>‚èπÔ∏è Stop Game</button>
        <button onclick="restartGame()" id="restartBtn" disabled>üîÑ Restart Game</button>
        <button onclick="clearLog()">üßπ Clear Log</button>
    </div>
    
    <div id="arena"></div>
    
    <div class="log" id="log"></div>
    
    <script>
        let currentGame = null;
        let gameInitialized = false;
        let cleanupInProgress = false;
        let eventListeners = [];
        
        function log(message) {
            const logEl = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logEl.innerHTML += `[${time}] ${message}<br>`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(message);
        }
        
        function setStatus(message, type = '') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }
        
        function updateButtons(starting = false, running = false) {
            document.getElementById('startBtn').disabled = starting || running;
            document.getElementById('stopBtn').disabled = !running;
            document.getElementById('restartBtn').disabled = !running;
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
        function addEventListenerSafely(target, type, handler) {
            target.addEventListener(type, handler);
            eventListeners.push({ target, type, handler });
        }
        
        // –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
        function removeAllEventListeners() {
            eventListeners.forEach(({ target, type, handler }) => {
                try {
                    target.removeEventListener(type, handler);
                } catch (error) {
                    log(`‚ö†Ô∏è Error removing event listener: ${error.message}`);
                }
            });
            eventListeners = [];
        }
        
        function cleanupGame() {
            if (cleanupInProgress) {
                log('üö´ Cleanup already in progress');
                return;
            }
            
            cleanupInProgress = true;
            log('üßπ Starting game cleanup...');
            
            try {
                // –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
                removeAllEventListeners();
                
                // –û—á–∏—Å—Ç–∫–∞ mk.js
                if (window.mk && typeof window.mk.reset === 'function' && currentGame) {
                    try {
                        window.mk.reset();
                        log('‚úÖ mk.js reset completed');
                    } catch (error) {
                        log(`‚ö†Ô∏è mk.js reset error: ${error.message}`);
                    }
                }
                
                // –û—á–∏—Å—Ç–∫–∞ DOM –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
                const arena = document.getElementById('arena');
                if (arena) {
                    try {
                        // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
                        while (arena.firstChild) {
                            arena.removeChild(arena.firstChild);
                        }
                        log('‚úÖ Arena container cleared');
                    } catch (error) {
                        // Fallback –æ—á–∏—Å—Ç–∫–∞
                        try {
                            arena.innerHTML = '';
                            log('‚úÖ Arena container cleared (fallback)');
                        } catch (e) {
                            log(`‚ùå Could not clear arena: ${e.message}`);
                        }
                    }
                }
                
                // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è
                currentGame = null;
                gameInitialized = false;
                
                log('üßπ Cleanup completed');
                setStatus('Game stopped', 'success');
                updateButtons();
                
            } catch (error) {
                log(`‚ùå Cleanup error: ${error.message}`);
                setStatus('Cleanup failed', 'error');
            } finally {
                cleanupInProgress = false;
            }
        }
        
        async function loadScript(src) {
            return new Promise((resolve, reject) => {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω –ª–∏ —Å–∫—Ä–∏–ø—Ç —É–∂–µ
                const existingScript = document.querySelector(`script[src="${src}"]`);
                if (existingScript) {
                    log(`‚úÖ Script already loaded: ${src}`);
                    resolve();
                    return;
                }

                const script = document.createElement('script');
                script.src = src;
                script.async = true;
                script.onload = () => {
                    log(`‚úÖ Script loaded: ${src}`);
                    resolve();
                };
                script.onerror = () => {
                    log(`‚ùå Failed to load script: ${src}`);
                    reject(new Error(`Failed to load script: ${src}`));
                };
                document.head.appendChild(script);
            });
        }
        
        async function startGame() {
            if (gameInitialized || cleanupInProgress) {
                log('üö´ Game already running or cleanup in progress');
                return;
            }
            
            log('üéÆ Starting game...');
            setStatus('Loading...', 'loading');
            updateButtons(true);
            
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–∫—Ä–∏–ø—Ç—ã
                await loadScript('/mk.js/game/src/movement.js');
                await loadScript('/mk.js/game/src/mk.js');
                
                // –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –¥–ª—è –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
                await new Promise(resolve => setTimeout(resolve, 500));
                
                if (!window.mk) {
                    throw new Error('mk.js not loaded');
                }
                
                log('‚úÖ Scripts loaded successfully');
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—É—Ç–µ–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
                if (window.mk.config) {
                    window.mk.config.IMAGES = '/mk.js/game/images/';
                    log('üñºÔ∏è Image paths configured');
                }
                
                const arena = document.getElementById('arena');
                if (!arena) {
                    throw new Error('Arena container not found');
                }
                
                // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
                arena.innerHTML = '';
                
                const options = {
                    arena: {
                        container: arena,
                        arena: window.mk.arenas.types.THRONE_ROOM,
                        width: 800,
                        height: 400
                    },
                    fighters: [
                        { name: 'Subzero' },
                        { name: 'Kano' }
                    ],
                    gameType: 'multiplayer',
                    callbacks: {
                        'attack': (attacker, defender, damage) => {
                            log(`‚öîÔ∏è Attack: ${attacker.getName()} -> ${defender.getName()} (${damage} dmg)`);
                        },
                        'game-end': (deadFighter) => {
                            log(`üèÅ Game ended: ${deadFighter.getName()} defeated`);
                            setTimeout(() => {
                                alert('Game Over!');
                            }, 1000);
                        }
                    }
                };
                
                log('üöÄ Starting mk.js...');
                const gamePromise = window.mk.start(options);
                
                if (!gamePromise) {
                    throw new Error('Failed to start mk.js - no promise returned');
                }
                
                if (typeof gamePromise.ready === 'function') {
                    gamePromise.ready(() => {
                        if (cleanupInProgress) return;
                        
                        log('üéâ Game ready!');
                        currentGame = window.mk.game;
                        gameInitialized = true;
                        setStatus('Game running', 'success');
                        updateButtons(false, true);
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
                        const handleKeyDown = (e) => {
                            if (cleanupInProgress) return;
                            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏–π –∫–ª–∞–≤–∏—à
                        };
                        
                        const handleKeyUp = (e) => {
                            if (cleanupInProgress) return;
                            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—É—Å–∫–∞–Ω–∏—è –∫–ª–∞–≤–∏—à
                        };
                        
                        addEventListenerSafely(document, 'keydown', handleKeyDown);
                        addEventListenerSafely(document, 'keyup', handleKeyUp);
                    });
                } else {
                    // Fallback –±–µ–∑ ready callback
                    setTimeout(() => {
                        if (cleanupInProgress) return;
                        
                        log('‚ö†Ô∏è No ready callback - using timeout fallback');
                        currentGame = window.mk.game;
                        gameInitialized = true;
                        setStatus('Game running (fallback)', 'success');
                        updateButtons(false, true);
                    }, 2000);
                }
                
                // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(() => {
                    if (cleanupInProgress) return;
                    
                    const childCount = arena.children.length;
                    log(`‚è∞ Force check: Arena has ${childCount} children`);
                    
                    if (childCount === 0 && !gameInitialized) {
                        log('‚ùå Game failed to initialize - no content in arena');
                        setStatus('Game failed to load', 'error');
                        updateButtons();
                    }
                }, 3000);
                
            } catch (error) {
                log(`‚ùå Failed to start game: ${error.message}`);
                setStatus(`Error: ${error.message}`, 'error');
                updateButtons();
            }
        }
        
        function stopGame() {
            log('‚èπÔ∏è Stopping game...');
            cleanupGame();
        }
        
        function restartGame() {
            log('üîÑ Restarting game...');
            cleanupGame();
            
            // –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ—á–∏—Å—Ç–∫–∏, –∑–∞—Ç–µ–º –∑–∞–ø—É—Å–∫–∞–µ–º –∑–∞–Ω–æ–≤–æ
            setTimeout(() => {
                if (!cleanupInProgress) {
                    startGame();
                }
            }, 1000);
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–∫—Ä—ã—Ç–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('beforeunload', () => {
            if (gameInitialized) {
                cleanupGame();
            }
        });
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        window.addEventListener('load', () => {
            log('üìÑ Page loaded');
            setStatus('Ready to start');
        });
    </script>
</body>
</html> 